<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contr√¥leur Anatomique Pr√©cis - Langues Sign√©es</title>
    <script src="../../../assets/vendor/three.min.js"></script>
    <script src="../../../assets/vendor/dat.gui.min.js"></script>
    <script src="anatomical-hand-controller.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            overflow: hidden;
        }

        #main-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            grid-template-rows: 60px 1fr 200px;
            height: 100vh;
            gap: 2px;
        }

        #header {
            grid-column: 1 / -1;
            background: linear-gradient(90deg, #2c3e50, #3498db);
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        #viewport {
            background: #2c2c2c;
            position: relative;
            overflow: hidden;
        }

        #control-panel {
            background: #333;
            border-left: 2px solid #555;
            overflow-y: auto;
            padding: 20px;
        }

        #timeline {
            grid-column: 1 / -1;
            background: #2a2a2a;
            border-top: 2px solid #555;
            padding: 10px;
        }

        .header-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-right: 20px;
        }

        .header-info {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .control-section {
            margin-bottom: 25px;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
        }

        .control-section h3 {
            margin: 0 0 15px 0;
            color: #3498db;
            border-bottom: 1px solid #555;
            padding-bottom: 8px;
        }

        .finger-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .joint-control {
            background: #444;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
        }

        .joint-control label {
            display: block;
            font-size: 0.8em;
            margin-bottom: 5px;
            color: #bbb;
        }

        .joint-control input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }

        .joint-control .value-display {
            font-size: 0.8em;
            color: #3498db;
            text-align: right;
        }

        .gesture-library {
            max-height: 200px;
            overflow-y: auto;
        }

        .gesture-item {
            background: #555;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #3498db;
        }

        .gesture-item:hover {
            background: #666;
            border-left-color: #e74c3c;
        }

        .gesture-item.active {
            background: #3498db;
            color: white;
        }

        .gesture-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .gesture-description {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .anatomical-info {
            background: #2a2a2a;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.85em;
        }

        .validation-status {
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
            font-size: 0.8em;
        }

        .validation-valid {
            background: #27ae60;
            color: white;
        }

        .validation-warning {
            background: #f39c12;
            color: white;
        }

        .validation-error {
            background: #e74c3c;
            color: white;
        }

        .timeline-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .timeline-track {
            height: 80px;
            background: #333;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }

        .keyframe {
            position: absolute;
            width: 3px;
            height: 100%;
            background: #3498db;
            cursor: pointer;
            transition: all 0.2s;
        }

        .keyframe:hover {
            background: #e74c3c;
            width: 5px;
        }

        .keyframe.selected {
            background: #f1c40f;
            width: 5px;
        }

        .playhead {
            position: absolute;
            width: 2px;
            height: 100%;
            background: #e74c3c;
            top: 0;
            pointer-events: none;
        }

        .muscle-activation {
            margin: 10px 0;
        }

        .muscle-bar {
            height: 20px;
            background: #444;
            border-radius: 10px;
            margin: 5px 0;
            overflow: hidden;
            position: relative;
        }

        .muscle-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #f1c40f, #e74c3c);
            transition: width 0.3s;
        }

        .muscle-label {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .export-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 0.9em;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn.danger {
            background: #e74c3c;
        }

        .btn.danger:hover {
            background: #c0392b;
        }

        .btn.success {
            background: #27ae60;
        }

        .btn.success:hover {
            background: #219a52;
        }

        .precision-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8em;
            pointer-events: none;
        }

        .joint-limit-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 5px;
        }

        .limit-safe { background: #27ae60; }
        .limit-warning { background: #f39c12; }
        .limit-danger { background: #e74c3c; }

        @media (max-width: 1200px) {
            #main-container {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr 300px 200px;
            }
            
            #control-panel {
                border-left: none;
                border-top: 2px solid #555;
            }
        }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="header">
            <div class="header-title">ü§ñ Contr√¥leur Anatomique 3D</div>
            <div class="header-info">
                Mod√©lisation pr√©cise pour langues sign√©es ‚Ä¢ 27 DDL par main ‚Ä¢ Validation biom√©canique temps r√©el
            </div>
        </div>

        <div id="viewport">
            <div class="precision-overlay" id="precision-info">
                <div><strong>üìç Pr√©cision :</strong> <span id="precision-level">Haute</span></div>
                <div><strong>‚ö° Articulations actives :</strong> <span id="active-joints">0/54</span></div>
                <div><strong>üéØ Validation :</strong> <span id="validation-status">‚úÖ Valide</span></div>
            </div>
        </div>

        <div id="control-panel">
            <!-- Biblioth√®que de gestes -->
            <div class="control-section">
                <h3>ü§ü Biblioth√®que Gestes DhƒÅtu</h3>
                <div class="gesture-library">
                    <div class="gesture-item active" onclick="loadPreciseGesture('drs_see')">
                        <div class="gesture-name">üëÅÔ∏è ‚àöd·πõ≈õ - Voir</div>
                        <div class="gesture-description">Index vers ≈ìil, mouvement directionnel</div>
                    </div>
                    <div class="gesture-item" onclick="loadPreciseGesture('sru_hear')">
                        <div class="gesture-name">üëÇ ‚àö≈õru - Entendre</div>
                        <div class="gesture-description">Main en coupe vers oreille</div>
                    </div>
                    <div class="gesture-item" onclick="loadPreciseGesture('vac_speak')">
                        <div class="gesture-name">üó£Ô∏è ‚àövac - Parler</div>
                        <div class="gesture-description">Main ouverte pr√®s bouche</div>
                    </div>
                    <div class="gesture-item" onclick="loadPreciseGesture('man_think')">
                        <div class="gesture-name">ü§î ‚àöman - Penser</div>
                        <div class="gesture-description">Index tapotant tempe</div>
                    </div>
                    <div class="gesture-item" onclick="loadPreciseGesture('yuj_unite')">
                        <div class="gesture-name">üôè ‚àöyuj - Unir</div>
                        <div class="gesture-description">Paumes jointes (A√±jali mudrƒÅ)</div>
                    </div>
                </div>
            </div>

            <!-- Contr√¥les de doigts pr√©cis -->
            <div class="control-section">
                <h3>‚úã Contr√¥les Articulaires Pr√©cis</h3>
                <div id="finger-controls">
                    <!-- G√©n√©r√© dynamiquement -->
                </div>
            </div>

            <!-- Validation anatomique -->
            <div class="control-section">
                <h3>üî¨ Validation Biom√©canique</h3>
                <div id="anatomical-validation">
                    <div class="validation-status validation-valid">
                        ‚úÖ Configuration anatomiquement valide
                    </div>
                    <div class="anatomical-info">
                        <strong>Limites articulaires :</strong> Respect√©es<br>
                        <strong>Contraintes tendineuses :</strong> OK<br>
                        <strong>Effort musculaire :</strong> <span id="effort-level">Mod√©r√©</span>
                    </div>
                </div>
            </div>

            <!-- Activation musculaire -->
            <div class="control-section">
                <h3>üí™ Activation Musculaire</h3>
                <div class="muscle-activation">
                    <div class="muscle-bar">
                        <div class="muscle-fill" id="flexors-bar" style="width: 0%"></div>
                        <div class="muscle-label">Fl√©chisseurs</div>
                    </div>
                    <div class="muscle-bar">
                        <div class="muscle-fill" id="extensors-bar" style="width: 0%"></div>
                        <div class="muscle-label">Extenseurs</div>
                    </div>
                    <div class="muscle-bar">
                        <div class="muscle-fill" id="intrinsics-bar" style="width: 0%"></div>
                        <div class="muscle-label">Intrins√®ques</div>
                    </div>
                </div>
            </div>

            <!-- Contr√¥les d'export -->
            <div class="control-section">
                <h3>üíæ Export et Enregistrement</h3>
                <div class="export-controls">
                    <button class="btn" onclick="recordGesture()">‚è∫Ô∏è Enregistrer</button>
                    <button class="btn" onclick="exportBVH()">üìä Export BVH</button>
                    <button class="btn success" onclick="validateGesture()">‚úÖ Valider</button>
                    <button class="btn danger" onclick="resetToNeutral()">üîÑ Reset</button>
                </div>
            </div>
        </div>

        <div id="timeline">
            <div class="timeline-controls">
                <button class="btn" onclick="playAnimation()">‚ñ∂Ô∏è Play</button>
                <button class="btn" onclick="pauseAnimation()">‚è∏Ô∏è Pause</button>
                <button class="btn" onclick="stopAnimation()">‚èπÔ∏è Stop</button>
                <span>Vitesse:</span>
                <input type="range" id="speed-control" min="0.1" max="3" step="0.1" value="1" onchange="updateAnimationSpeed()">
                <span id="speed-display">1.0x</span>
            </div>
            <div class="timeline-track" id="timeline-track">
                <div class="playhead" id="playhead" style="left: 0%"></div>
                <!-- Keyframes g√©n√©r√©s dynamiquement -->
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let scene, camera, renderer, anatomicalController;
        let currentGesture = 'drs_see';
        let isPlaying = false;
        let currentTime = 0;
        let animationDuration = 2.0;

        // Initialisation
        window.addEventListener('load', () => {
            initializeSystem();
        });

        function initializeSystem() {
            // Initialiser le contr√¥leur anatomique
            anatomicalController = new AnatomicalHandController();
            
            // Initialiser Three.js
            initThreeJS();
            
            // G√©n√©rer les contr√¥les d'interface
            generateFingerControls();
            
            // Charger le geste par d√©faut
            loadPreciseGesture(currentGesture);
            
            // D√©marrer la boucle d'animation
            animate();
        }

        function initThreeJS() {
            // Configuration identique au fichier pr√©c√©dent mais optimis√©e
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x2c2c2c);

            camera = new THREE.PerspectiveCamera(75, 
                document.getElementById('viewport').clientWidth / 
                document.getElementById('viewport').clientHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 2.5);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            const viewport = document.getElementById('viewport');
            renderer.setSize(viewport.clientWidth, viewport.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            viewport.appendChild(renderer.domElement);

            // √âclairage sp√©cialis√© pour analyse anatomique
            setupAnalyticalLighting();
            
            // Cr√©er le mod√®le anatomique d√©taill√©
            createAnatomicalModel();
        }

        function setupAnalyticalLighting() {
            // √âclairage diffus pour visibilit√© g√©n√©rale
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambientLight);

            // √âclairage principal pour mod√©lisation
            const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
            mainLight.position.set(3, 5, 3);
            mainLight.castShadow = true;
            scene.add(mainLight);

            // √âclairage de remplissage
            const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
            fillLight.position.set(-3, 2, -2);
            scene.add(fillLight);

            // √âclairage sp√©cialis√© pour les mains
            const handLight = new THREE.SpotLight(0xffffff, 0.6);
            handLight.position.set(0, 2, 1);
            handLight.target.position.set(0, 1.2, 0);
            handLight.angle = Math.PI / 4;
            handLight.penumbra = 0.1;
            scene.add(handLight);
            scene.add(handLight.target);
        }

        function createAnatomicalModel() {
            // Cr√©er le mod√®le avec pr√©cision anatomique maximale
            // (R√©utiliser la logique du fichier pr√©c√©dent mais avec plus de d√©tails)
            
            // Pour l'instant, mod√®le simplifi√© pour d√©monstration
            const geometry = new THREE.BoxGeometry(0.3, 1.8, 0.2);
            const material = new THREE.MeshLambertMaterial({ color: 0xFFDBB5 });
            const body = new THREE.Mesh(geometry, material);
            body.position.y = 0.9;
            scene.add(body);

            // Ajouter des mains d√©taill√©es (√† impl√©menter avec toutes les phalanges)
            createDetailedHands();
        }

        function createDetailedHands() {
            // Impl√©mentation d√©taill√©e des mains avec toutes les articulations
            // (Code anatomique du contr√¥leur)
        }

        function generateFingerControls() {
            const container = document.getElementById('finger-controls');
            const fingers = ['thumb', 'index', 'middle', 'ring', 'pinky'];
            
            fingers.forEach(finger => {
                const fingerDiv = document.createElement('div');
                fingerDiv.className = 'finger-controls';
                fingerDiv.innerHTML = `<h4>${finger.toUpperCase()}</h4>`;
                
                // Joints sp√©cifiques selon le doigt
                const joints = finger === 'thumb' ? 
                    ['cmc_flexion', 'cmc_abduction', 'mcp_flexion', 'ip_flexion'] :
                    ['mcp_flexion', 'mcp_abduction', 'pip_flexion', 'dip_flexion'];
                
                joints.forEach(joint => {
                    const jointControl = document.createElement('div');
                    jointControl.className = 'joint-control';
                    
                    const limits = getJointLimits(finger, joint);
                    
                    jointControl.innerHTML = `
                        <label>${joint.replace('_', ' ').toUpperCase()}</label>
                        <input type="range" 
                               id="${finger}_${joint}" 
                               min="${limits.min}" 
                               max="${limits.max}" 
                               value="${limits.neutral}"
                               oninput="updateJoint('${finger}', '${joint}', this.value)">
                        <div class="value-display">
                            <span id="${finger}_${joint}_value">${limits.neutral}¬∞</span>
                            <span class="joint-limit-indicator limit-safe" id="${finger}_${joint}_indicator"></span>
                        </div>
                    `;
                    
                    fingerDiv.appendChild(jointControl);
                });
                
                container.appendChild(fingerDiv);
            });
        }

        function getJointLimits(finger, joint) {
            // Retourner les limites anatomiques r√©elles du contr√¥leur
            const anatomy = anatomicalController.handAnatomy[finger];
            if (!anatomy) return { min: -90, max: 90, neutral: 0 };
            
            const jointType = joint.split('_')[1]; // flexion, abduction, etc.
            const jointName = joint.split('_')[0]; // mcp, pip, etc.
            
            if (anatomy[jointName] && anatomy[jointName][jointType + '_extension']) {
                const limits = anatomy[jointName][jointType + '_extension'];
                return {
                    min: limits.min,
                    max: limits.max,
                    neutral: limits.neutral
                };
            }
            
            return { min: -90, max: 90, neutral: 0 };
        }

        function loadPreciseGesture(gestureName) {
            currentGesture = gestureName;
            
            // Marquer comme actif dans l'interface
            document.querySelectorAll('.gesture-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.gesture-item').classList.add('active');
            
            // Charger la configuration du geste
            const gestureData = anatomicalController.mocapData.reference_gestures[gestureName];
            if (!gestureData) return;
            
            // Appliquer la configuration anatomique
            applyGestureConfiguration(gestureData);
            
            // Mettre √† jour la timeline
            updateTimeline(gestureData);
            
            // Valider le geste
            validateCurrentGesture();
        }

        function applyGestureConfiguration(gestureData) {
            // Appliquer la premi√®re keyframe du geste
            const firstFrame = gestureData.keyframes[0];
            const config = anatomicalController.generateHandConfiguration(firstFrame.config);
            
            if (config) {
                // Mettre √† jour les contr√¥leurs d'interface
                Object.keys(config.fingers).forEach(finger => {
                    Object.keys(config.fingers[finger]).forEach(joint => {
                        const jointData = config.fingers[finger][joint];
                        if (jointData.flexion !== undefined) {
                            updateJointControl(finger, joint + '_flexion', jointData.flexion);
                        }
                        if (jointData.abduction !== undefined) {
                            updateJointControl(finger, joint + '_abduction', jointData.abduction);
                        }
                    });
                });
            }
        }

        function updateJointControl(finger, joint, value) {
            const control = document.getElementById(`${finger}_${joint}`);
            const display = document.getElementById(`${finger}_${joint}_value`);
            const indicator = document.getElementById(`${finger}_${joint}_indicator`);
            
            if (control) {
                control.value = value;
                display.textContent = value + '¬∞';
                
                // Mettre √† jour l'indicateur de limite
                const limits = getJointLimits(finger, joint);
                const percentage = (value - limits.min) / (limits.max - limits.min);
                
                if (percentage < 0.1 || percentage > 0.9) {
                    indicator.className = 'joint-limit-indicator limit-danger';
                } else if (percentage < 0.2 || percentage > 0.8) {
                    indicator.className = 'joint-limit-indicator limit-warning';
                } else {
                    indicator.className = 'joint-limit-indicator limit-safe';
                }
            }
        }

        function updateJoint(finger, joint, value) {
            // Mettre √† jour l'affichage
            updateJointControl(finger, joint, value);
            
            // Appliquer au mod√®le 3D
            applyJointToModel(finger, joint, value);
            
            // Mettre √† jour la validation
            validateCurrentGesture();
            
            // Mettre √† jour l'activation musculaire
            updateMuscleActivation();
        }

        function applyJointToModel(finger, joint, value) {
            // Appliquer la rotation au mod√®le 3D Three.js
            // (Impl√©mentation sp√©cifique au mod√®le cr√©√©)
        }

        function validateCurrentGesture() {
            // Utiliser le syst√®me de validation du contr√¥leur
            const validation = anatomicalController.validateGestureAnatomy([getCurrentGestureState()]);
            
            const statusElement = document.getElementById('validation-status');
            const validationContainer = document.getElementById('anatomical-validation');
            
            if (validation.valid) {
                statusElement.textContent = '‚úÖ Valide';
                statusElement.className = 'validation-status validation-valid';
            } else if (validation.warnings.length > 0) {
                statusElement.textContent = '‚ö†Ô∏è Attention';
                statusElement.className = 'validation-status validation-warning';
            } else {
                statusElement.textContent = '‚ùå Erreurs';
                statusElement.className = 'validation-status validation-error';
            }
            
            // Afficher les d√©tails de validation
            updateValidationDetails(validation);
        }

        function getCurrentGestureState() {
            // Extraire l'√©tat actuel de tous les joints
            const state = {
                time: currentTime,
                hand_pos: [0, 1.2, 0.4], // Position actuelle
                finger_positions: {}
            };
            
            // Parcourir tous les contr√¥les et extraire les valeurs
            const fingers = ['thumb', 'index', 'middle', 'ring', 'pinky'];
            fingers.forEach(finger => {
                state.finger_positions[finger] = {};
                // Extraire les valeurs des contr√¥les d'interface
            });
            
            return state;
        }

        function updateValidationDetails(validation) {
            const infoElement = document.querySelector('.anatomical-info');
            let html = '';
            
            if (validation.errors.length > 0) {
                html += '<strong style="color: #e74c3c;">Erreurs:</strong><br>';
                validation.errors.forEach(error => {
                    html += `‚Ä¢ ${error}<br>`;
                });
            }
            
            if (validation.warnings.length > 0) {
                html += '<strong style="color: #f39c12;">Avertissements:</strong><br>';
                validation.warnings.forEach(warning => {
                    html += `‚Ä¢ ${warning}<br>`;
                });
            }
            
            if (validation.suggestions.length > 0) {
                html += '<strong style="color: #3498db;">Suggestions:</strong><br>';
                validation.suggestions.forEach(suggestion => {
                    html += `‚Ä¢ ${suggestion}<br>`;
                });
            }
            
            if (html === '') {
                html = '<strong style="color: #27ae60;">‚úÖ Configuration optimale</strong>';
            }
            
            infoElement.innerHTML = html;
        }

        function updateMuscleActivation() {
            // Calculer l'activation musculaire actuelle
            const config = getCurrentGestureState();
            const activation = anatomicalController.calculateMuscleActivation(config);
            
            // Mettre √† jour les barres visuelles
            document.getElementById('flexors-bar').style.width = (activation.flexors * 100) + '%';
            document.getElementById('extensors-bar').style.width = (activation.extensors * 100) + '%';
            document.getElementById('intrinsics-bar').style.width = (activation.intrinsics * 100) + '%';
            
            // Mettre √† jour l'affichage de l'effort
            const effortLevel = activation.total_effort;
            let effortText = 'Minimal';
            if (effortLevel > 0.7) effortText = 'Intense';
            else if (effortLevel > 0.4) effortText = 'Mod√©r√©';
            else if (effortLevel > 0.2) effortText = 'L√©ger';
            
            document.getElementById('effort-level').textContent = effortText;
        }

        function updateTimeline(gestureData) {
            const track = document.getElementById('timeline-track');
            
            // Effacer les keyframes existantes
            track.querySelectorAll('.keyframe').forEach(kf => kf.remove());
            
            // Ajouter les nouvelles keyframes
            gestureData.keyframes.forEach((keyframe, index) => {
                const kfElement = document.createElement('div');
                kfElement.className = 'keyframe';
                kfElement.style.left = (keyframe.time / animationDuration * 100) + '%';
                kfElement.title = `Keyframe ${index + 1} (${keyframe.time}s)`;
                kfElement.onclick = () => seekToKeyframe(keyframe.time);
                track.appendChild(kfElement);
            });
        }

        function seekToKeyframe(time) {
            currentTime = time;
            document.getElementById('playhead').style.left = (time / animationDuration * 100) + '%';
            // Interpoler vers cette keyframe
        }

        function playAnimation() {
            isPlaying = true;
            // Logique d'animation
        }

        function pauseAnimation() {
            isPlaying = false;
        }

        function stopAnimation() {
            isPlaying = false;
            currentTime = 0;
            seekToKeyframe(0);
        }

        function updateAnimationSpeed() {
            const speed = document.getElementById('speed-control').value;
            document.getElementById('speed-display').textContent = speed + 'x';
        }

        function recordGesture() {
            const gestureState = getCurrentGestureState();
            const report = anatomicalController.generateBiomechanicalReport(currentGesture);
            
            const recordData = {
                timestamp: new Date().toISOString(),
                gesture_name: currentGesture,
                state: gestureState,
                biomechanical_report: report,
                validation: validateCurrentGesture()
            };
            
            // Export en JSON
            const blob = new Blob([JSON.stringify(recordData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `anatomical_gesture_${currentGesture}_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportBVH() {
            const bvhData = anatomicalController.exportToBVH(currentGesture);
            if (bvhData) {
                const bvhString = formatBVHData(bvhData);
                const blob = new Blob([bvhString], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gesture_${currentGesture}.bvh`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        function formatBVHData(bvhData) {
            // Formater les donn√©es BVH selon le standard
            return `HIERARCHY
ROOT ${bvhData.hierarchy.root}
{
    OFFSET 0.0 0.0 0.0
    CHANNELS 6 Xposition Yposition Zposition Zrotation Xrotation Yrotation
    // ... Structure compl√®te des joints
}
MOTION
Frames: ${bvhData.header.frames}
Frame Time: ${bvhData.header.frameTime}
// ... Donn√©es de motion
`;
        }

        function validateGesture() {
            const report = anatomicalController.generateBiomechanicalReport(currentGesture);
            alert(`Rapport de validation pour ${currentGesture}:
            
Score de difficult√©: ${(report.difficulty_score * 100).toFixed(1)}%
Effort musculaire: ${(report.muscle_activation.total_effort * 100).toFixed(1)}%
Validation: ${report.biomechanical_validation.valid ? 'VALIDE' : 'ERREURS'}

${report.recommendations.join('\n‚Ä¢ ')}`);
        }

        function resetToNeutral() {
            // R√©initialiser tous les contr√¥les √† position neutre
            loadPreciseGesture('neutral');
        }

        function animate() {
            requestAnimationFrame(animate);
            
            // Mise √† jour de la timeline si en lecture
            if (isPlaying) {
                currentTime += 0.016; // 60 FPS
                if (currentTime >= animationDuration) {
                    stopAnimation();
                } else {
                    document.getElementById('playhead').style.left = (currentTime / animationDuration * 100) + '%';
                }
            }
            
            // Mise √† jour des compteurs
            updateCounters();
            
            // Rendu
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        function updateCounters() {
            // Compter les articulations actives
            let activeJoints = 0;
            document.querySelectorAll('input[type="range"]').forEach(input => {
                const limits = getJointLimits(
                    input.id.split('_')[0], 
                    input.id.split('_').slice(1).join('_')
                );
                if (Math.abs(input.value - limits.neutral) > 5) {
                    activeJoints++;
                }
            });
            
            document.getElementById('active-joints').textContent = `${activeJoints}/54`;
        }

        // Gestion du redimensionnement
        window.addEventListener('resize', () => {
            if (camera && renderer) {
                const viewport = document.getElementById('viewport');
                camera.aspect = viewport.clientWidth / viewport.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(viewport.clientWidth, viewport.clientHeight);
            }
        });
    </script>
</body>
</html>
