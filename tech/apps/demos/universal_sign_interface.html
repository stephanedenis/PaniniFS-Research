<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interface Universelle - DhƒÅtu & Langues Sign√©es</title>
    <style>
        body {
            margin: 0;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            font-family: 'Segoe UI', Arial, sans-serif;
            overflow-x: hidden;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
        }
        
        #dhatu-panel {
            position: fixed;
            left: 10px;
            top: 10px;
            width: 300px;
            height: calc(100vh - 20px);
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ff6600;
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(15px);
            overflow-y: auto;
            z-index: 1000;
        }
        
        #canvas-area {
            flex: 1;
            margin-left: 340px;
            position: relative;
        }
        
    #language-selector {
            position: fixed;
            right: 10px;
            top: 10px;
            width: 250px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(15px);
            z-index: 1000;
        }
    .language-btn { background: linear-gradient(145deg, #44aa77, #337755); box-shadow: 0 0 10px rgba(0,255,136,0.3); }
        
        #status-bar {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-radius: 25px;
            border: 1px solid #ffffff;
            color: #ffffff;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }
        
    /* .dhatu-visualization supprim√© */
        /* Overlay central supprim√© pour lib√©rer l'espace sc√®ne */
        
        .dhatu-large {
            font-size: 48px;
            color: #ff6600;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 102, 0, 0.5);
        }
        
        .dhatu-description {
            font-size: 18px;
            color: #ffffff;
            margin-bottom: 15px;
        }
        
        .dhatu-examples {
            font-size: 14px;
            color: #cccccc;
            font-style: italic;
        }
        
        .alphabet-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            margin: 10px 0;
        }
        
        .alphabet-btn {
            background: rgba(0, 255, 136, 0.3);
            border: 1px solid #00ff88;
            color: #ffffff;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .alphabet-btn:hover {
            background: rgba(0, 255, 136, 0.5);
            transform: scale(1.1);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- Panel des DhƒÅtu (c≈ìur du syst√®me) -->
        <div id="dhatu-panel">
            <div class="panel-title">üß¨ DHƒÄTU UNIVERSELS</div>
                        <div id="dhatu-sections"></div>
                        <div id="alphabet-block" style="margin-top:18px;">
                                <div class="panel-title" style="font-size:14px;">Alphabet & Chiffres</div>
                                <div id="alpha-grid" class="alphabet-grid"></div>
                                <div id="digit-grid" class="alphabet-grid" style="grid-template-columns: repeat(10,1fr); margin-top:8px;"></div>
                        </div>
                        <script>
                        // G√©n√©ration dynamique des sections DhƒÅtu + phrases
                        const PHRASES_BY_DHATU = {
                            COMM: [
                                { key:'hello', label:'Bonjour / Hello' },
                                { key:'thank_you', label:'Merci / Thank you' },
                                { key:'how_are_you', label:'Comment allez-vous ?' },
                                { key:'goodbye', label:'Au revoir / Goodbye' },
                                { key:'please', label:"S'il vous pla√Æt" }
                            ],
                            FEEL: [ { key:'i_love_you', label:'Je vous aime' } ]
                        };
                        function buildDhatuPanel(){
                            const container = document.getElementById('dhatu-sections');
                            container.innerHTML='';
                            Object.entries(dhatuData).forEach(([code,info])=>{
                                const wrap = document.createElement('div');
                                wrap.className='dhatu-collapsible';
                                wrap.style.marginBottom='8px';
                                const header = document.createElement('div');
                                header.style.cursor='pointer';
                                header.style.display='flex';
                                header.style.alignItems='center';
                                header.style.justifyContent='space-between';
                                header.style.background='rgba(255,102,0,0.15)';
                                header.style.padding='6px 8px';
                                header.style.border='1px solid #ff6600';
                                header.style.borderRadius='6px';
                                header.innerHTML = `<span style="font-weight:bold;color:#ff8800;">${code}</span><span style="font-size:11px;color:#ccc;">${info.frequency}</span>`;
                                const body = document.createElement('div');
                                body.style.display='none';
                                body.style.padding='6px 4px 10px';
                                body.style.fontSize='12px';
                                body.innerHTML = `<div style='color:#fff;margin:4px 0;'>${info.concept}</div><div style='color:#bbb;font-style:italic;margin-bottom:6px;'>${info.examples}</div>`;
                                const phrases = PHRASES_BY_DHATU[code] || [];
                                if(phrases.length){
                                    const phrWrap = document.createElement('div');
                                    phrWrap.style.display='flex';
                                    phrWrap.style.flexDirection='column';
                                    phrases.forEach(p=>{
                                        const btn=document.createElement('button');
                                        btn.className='language-btn';
                                        btn.style.margin='2px 0';
                                        btn.textContent = p.label;
                                        btn.onclick=()=>performPhrase(p.key);
                                        phrWrap.appendChild(btn);
                                    });
                                    body.appendChild(phrWrap);
                                }
                                header.addEventListener('click',()=>{
                                    body.style.display = body.style.display==='none' ? 'block':'none';
                                });
                                wrap.appendChild(header); wrap.appendChild(body); container.appendChild(wrap);
                            });
                            // Alphabet dynamique
                            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
                            const alphaGrid=document.getElementById('alpha-grid');
                            letters.forEach(L=>{ const b=document.createElement('button'); b.className='alphabet-btn'; b.textContent=L; b.onclick=()=>performLetter(L); alphaGrid.appendChild(b); });
                            const digits='0123456789'.split('');
                            const digitGrid=document.getElementById('digit-grid');
                            digits.forEach(d=>{ const b=document.createElement('button'); b.className='alphabet-btn'; b.textContent=d; b.onclick=()=>performDigit(d); digitGrid.appendChild(b); });
                        }
                        </script>
            <div class="dhatu-item" onclick="selectDhatu('RELATE')" data-dhatu="RELATE">
                <div class="dhatu-frequency">57</div>
                <div class="dhatu-name">RELATE</div>
                <div class="dhatu-concept">Relations spatiales, possession</div>
            </div>
            <div class="dhatu-item" onclick="selectDhatu('MODAL')" data-dhatu="MODAL">
                <div class="dhatu-frequency">35</div>
                <div class="dhatu-name">MODAL</div>
                <div class="dhatu-concept">Modalit√©, n√©gation, possibilit√©</div>
            </div>
            <div class="dhatu-item" onclick="selectDhatu('EXIST')" data-dhatu="EXIST">
                <div class="dhatu-frequency">20</div>
                <div class="dhatu-name">EXIST</div>
                <div class="dhatu-concept">Existence, temporalit√©</div>
            </div>
            <div class="dhatu-item" onclick="selectDhatu('EVAL')" data-dhatu="EVAL">
                <div class="dhatu-frequency">20</div>
                <div class="dhatu-name">EVAL</div>
                <div class="dhatu-concept">√âvaluation, quantification</div>
            </div>
            <div class="dhatu-item" onclick="selectDhatu('COMM')" data-dhatu="COMM">
                <div class="dhatu-frequency">19</div>
                <div class="dhatu-name">COMM</div>
                <div class="dhatu-concept">Communication, transmission</div>
            </div>
            <div class="dhatu-item" onclick="selectDhatu('CAUSE')" data-dhatu="CAUSE">
                <div class="dhatu-frequency">20</div>
                <div class="dhatu-name">CAUSE</div>
                <div class="dhatu-concept">Causalit√©, agent-action</div>
            </div>
            <div class="dhatu-item" onclick="selectDhatu('ITER')" data-dhatu="ITER">
                <div class="dhatu-frequency">20</div>
                <div class="dhatu-name">ITER</div>
                <div class="dhatu-concept">R√©p√©tition, s√©quentialit√©</div>
            </div>
            <div class="dhatu-item" onclick="selectDhatu('DECIDE')" data-dhatu="DECIDE">
                <div class="dhatu-frequency">15</div>
                <div class="dhatu-name">DECIDE</div>
                <div class="dhatu-concept">Choix, conditions</div>
            </div>
            <div class="dhatu-item" onclick="selectDhatu('FEEL')" data-dhatu="FEEL">
                <div class="dhatu-frequency">12</div>
                <div class="dhatu-name">FEEL</div>
                <div class="dhatu-concept">√âmotions, attitudes</div>
            </div>
            
            <div style="margin-top: 20px; padding: 10px; background: rgba(255, 102, 0, 0.1); border-radius: 8px;">
                <div style="color: #ffaa44; font-size: 12px; font-weight: bold;">COUVERTURE UNIVERSELLE</div>
                <div style="color: #ffffff; font-size: 11px;">92% sur 20 langues test√©es</div>
                <div style="color: #cccccc; font-size: 10px;">Validation cross-linguistique</div>
            </div>
        </div>
        
        <!-- Zone de visualisation 3D -->
    <div id="canvas-area"><!-- Zone centrale libre pour 3D --></div>
        
        <!-- S√©lecteur de langues sign√©es -->
        <div id="language-selector">
            <div class="panel-title">üåç LANGUES SIGN√âES</div>
            
            <!-- Am√©rique du Nord -->
            <div class="language-group">
                <div class="language-title">Am√©rique du Nord</div>
                <button class="language-btn active" onclick="selectLanguage('LSQ')">LSQ (Qu√©bec)</button>
                <button class="language-btn" onclick="selectLanguage('ASL')">ASL (USA)</button>
                <button class="language-btn" onclick="selectLanguage('LSM')">LSM (Mexique)</button>
            </div>
            
            <!-- Europe -->
            <div class="language-group">
                <div class="language-title">Europe</div>
                <button class="language-btn" onclick="selectLanguage('LSF')">LSF (France)</button>
                <button class="language-btn" onclick="selectLanguage('BSL')">BSL (Britannique)</button>
                <button class="language-btn" onclick="selectLanguage('DGS')">DGS (Allemagne)</button>
                <button class="language-btn" onclick="selectLanguage('LIS')">LIS (Italie)</button>
                <button class="language-btn" onclick="selectLanguage('SSL')">SSL (Su√®de)</button>
                <button class="language-btn" onclick="selectLanguage('NGT')">NGT (Pays-Bas)</button>
                <button class="language-btn" onclick="selectLanguage('LSE')">LSE (Espagne)</button>
            </div>
            
            <!-- Asie -->
            <div class="language-group">
                <div class="language-title">Asie</div>
                <button class="language-btn" onclick="selectLanguage('JSL')">JSL (Japon)</button>
                <button class="language-btn" onclick="selectLanguage('CSL')">CSL (Chine)</button>
                <button class="language-btn" onclick="selectLanguage('KSL')">KSL (Cor√©e)</button>
                <button class="language-btn" onclick="selectLanguage('IPSL')">IPSL (Indo-Pakistan)</button>
                <button class="language-btn" onclick="selectLanguage('TSL')">TSL (Tha√Ølande)</button>
            </div>
            
            <!-- Oc√©anie -->
            <div class="language-group">
                <div class="language-title">Oc√©anie</div>
                <button class="language-btn" onclick="selectLanguage('Auslan')">Auslan (Australie)</button>
                <button class="language-btn" onclick="selectLanguage('NZSL')">NZSL (N-Z√©lande)</button>
            </div>
            
            <!-- Afrique -->
            <div class="language-group">
                <div class="language-title">Afrique</div>
                <button class="language-btn" onclick="selectLanguage('SASL')">SASL (Afr. Sud)</button>
                <button class="language-btn" onclick="selectLanguage('LST')">LST (Tunisie)</button>
            </div>
            
            <!-- Phrases communes internationales -->
            <div class="language-group">
                <div class="language-title">Phrases Communes</div>
                <button class="language-btn" onclick="performPhrase('hello')">Bonjour/Hello</button>
                <button class="language-btn" onclick="performPhrase('thank_you')">Merci/Thank you</button>
                <button class="language-btn" onclick="performPhrase('how_are_you')">Comment allez-vous?</button>
                <button class="language-btn" onclick="performPhrase('i_love_you')">Je vous aime</button>
                <button class="language-btn" onclick="performPhrase('goodbye')">Au revoir/Goodbye</button>
                <button class="language-btn" onclick="performPhrase('please')">S'il vous pla√Æt</button>
                </div>
                <!-- Phrases d√©plac√©es dans les sections DhƒÅtu -->
            
            <!-- Contr√¥les mod√®les 3D (r√©duit aux mains proc√©durales r√©centes) -->
            <!-- Mod√®le 3D charg√© automatiquement (bouton retir√©) -->
            
            <!-- Alphabet universel -->
            <div class="language-group">
                <div class="language-title">Alphabet (current: LSQ)</div>
                <div class="alphabet-grid">
                    <button class="alphabet-btn" onclick="performLetter('A')">A</button>
                    <button class="alphabet-btn" onclick="performLetter('B')">B</button>
                    <button class="alphabet-btn" onclick="performLetter('C')">C</button>
                    <button class="alphabet-btn" onclick="performLetter('D')">D</button>
                    <button class="alphabet-btn" onclick="performLetter('E')">E</button>
                    <button class="alphabet-btn" onclick="performLetter('F')">F</button>
                    <button class="alphabet-btn" onclick="performLetter('G')">G</button>
                    <button class="alphabet-btn" onclick="performLetter('H')">H</button>
                    <button class="alphabet-btn" onclick="performLetter('I')">I</button>
                    <button class="alphabet-btn" onclick="performLetter('J')">J</button>
                    <button class="alphabet-btn" onclick="performLetter('K')">K</button>
                    <button class="alphabet-btn" onclick="performLetter('L')">L</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Barre de statut -->
    <div id="status-bar">
        DhƒÅtu: RELATE ‚Ä¢ Langue: LSQ (Qu√©bec) ‚Ä¢ Couverture: 92% universelle
    </div>

    <!-- Scripts Three.js et logique -->
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>
    <script>
        // Configuration globale - ACCESSIBLE GLOBALEMENT
        window.scene = null;
        window.camera = null;
        window.renderer = null;
        window.mixer = null;
        window.clock = null;
        window.currentHands = { left: null, right: null };
        window.currentDhatu = 'RELATE';
        window.currentLanguage = 'LSQ';
    window.handControllers = null; // contr√¥leurs proc√©duraux retir√©s
        window.anatomyHelpers = [];
        
        // Debug logs
        function debugLog(message) {
            console.log(`üîß DEBUG: ${message}`);
        }
        
    // Mod√®le de recherche unique (main droite)
    const RESEARCH_HAND_MODEL = 'https://market.pmnd.rs/api/files/right-hand-white-webxr.glb';
        
        // Donn√©es des dhƒÅtu avec descriptions compl√®tes
        const dhatuData = {
            'RELATE': {
                name: 'RELATE',
                concept: 'Relations spatiales et possession',
                examples: 'Manifestations: "dans, sur, de, avec" ‚Ä¢ Spatial: in, on, above ‚Ä¢ Possession: ownership, belonging',
                frequency: 57,
                universality: '19/20 langues'
            },
            'MODAL': {
                name: 'MODAL',
                concept: 'Modalit√©, n√©gation, possibilit√©',
                examples: 'Peut-√™tre, impossible, certainement ‚Ä¢ can, must, should ‚Ä¢ n√©cessit√©, possibilit√©',
                frequency: 35,
                universality: '20/20 langues'
            },
            'EXIST': {
                name: 'EXIST',
                concept: 'Existence, temporalit√©',
                examples: '√ätre, exister, maintenant ‚Ä¢ is, was, will be ‚Ä¢ pr√©sence, absence temporelle',
                frequency: 20,
                universality: '20/20 langues'
            },
            'EVAL': {
                name: 'EVAL',
                concept: '√âvaluation, quantification',
                examples: 'Plus, moins, √©gal ‚Ä¢ big, small, many ‚Ä¢ comparaison, mesure, quantit√©',
                frequency: 20,
                universality: '20/20 langues'
            },
            'COMM': {
                name: 'COMM',
                concept: 'Communication, transmission',
                examples: 'Dire, raconter, entendre ‚Ä¢ speak, tell, report ‚Ä¢ √©change informationnel',
                frequency: 19,
                universality: '19/20 langues'
            },
            'CAUSE': {
                name: 'CAUSE',
                concept: 'Causalit√©, agent-action',
                examples: 'Faire, causer, agir ‚Ä¢ make, do, create ‚Ä¢ structure agent-action-objet',
                frequency: 20,
                universality: '18/20 langues'
            },
            'ITER': {
                name: 'ITER',
                concept: 'R√©p√©tition, s√©quentialit√©',
                examples: 'R√©p√©ter, encore, suivant ‚Ä¢ again, next, loop ‚Ä¢ progression temporelle',
                frequency: 20,
                universality: '17/20 langues'
            },
            'DECIDE': {
                name: 'DECIDE',
                concept: 'Choix, conditions',
                examples: 'Si, alors, choisir ‚Ä¢ if, when, choose ‚Ä¢ structures conditionnelles',
                frequency: 15,
                universality: '16/20 langues'
            },
            'FEEL': {
                name: 'FEEL',
                concept: '√âmotions, attitudes',
                examples: 'Aimer, d√©tester, ressentir ‚Ä¢ love, hate, feel ‚Ä¢ dimension affective',
                frequency: 12,
                universality: '15/20 langues'
            }
        };
        
        // Initialisation
    async function init() {
            debugLog('Initialisation du syst√®me...');
            try {
                if (typeof THREE === 'undefined') {
                    console.error('‚ùå THREE.js non charg√© !');
                    return;
                }
                debugLog('Three.js d√©tect√©: ' + THREE.REVISION);

                // Pr√©charger donn√©es (mains + NMF + visage)
                let signVersions = null; let facialVersion = null;
                try {
                    const [signModule, facialModule, composerModule, validatorModule] = await Promise.all([
                        import('./modules/signDataLoader.js'),
                        import('./modules/facialPresetLoader.js'),
                        import('./modules/signComposer.js'),
                        import('./modules/signValidator.js')
                    ]);
                    signVersions = await signModule.preloadAll();
                    await facialModule.loadFacialPresets();
                    facialVersion = facialModule.getFacialVersion();
                    window.signRuntime = {
                        hand:null,
                        data: {
                            getHandshapes: signModule.getHandshapes,
                            getHandshape: signModule.getHandshape,
                            getNmfRules: signModule.getNmfRules,
                            getFacialPresets: facialModule.getFacialPresets
                        },
                        compose: composerModule.composeSign,
                        validate: validatorModule.validateSign
                    };
                    debugLog(`Presets charg√©s: handshapes v${signVersions.handshapes} ‚Ä¢ nmfRules v${signVersions.nmfRules} ‚Ä¢ facial v${facialVersion}`);
                    setupDiagnosticsOverlay(signVersions, facialVersion);
                } catch (e) {
                    console.warn('‚ö†Ô∏è √âchec pr√©chargement runtime sign√©:', e);
                }

                initThreeJS();
                if(typeof buildDhatuPanel==='function') buildDhatuPanel();
                updateStatus();
                debugLog('Initialisation termin√©e avec succ√®s');
            } catch (error) {
                console.error('‚ùå Erreur initialisation:', error);
            }
        }
        
        function initThreeJS() {
            debugLog('Initialisation Three.js...');
            
            window.scene = new THREE.Scene();
            window.scene.name = 'MainScene';
            
            const canvasArea = document.getElementById('canvas-area');
            if (!canvasArea) {
                console.error('‚ùå Zone canvas non trouv√©e !');
                return;
            }
            
            window.camera = new THREE.PerspectiveCamera(75, canvasArea.clientWidth / canvasArea.clientHeight, 0.1, 1000);
            window.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            
            window.renderer.setSize(canvasArea.clientWidth, canvasArea.clientHeight);
            window.renderer.shadowMap.enabled = true;
            window.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            window.renderer.setClearColor(0x000000, 0.1);
            
            canvasArea.appendChild(window.renderer.domElement);
            debugLog('Canvas ajout√© au DOM');
            
            // √âclairage cin√©matique
            setupAdvancedLighting();
            
            // Chargement automatique du mod√®le de main (droite unique)
            debugLog('Chargement de la main de recherche (droite)');
            loadResearchHand();
            
            window.camera.position.set(0, 1, 3);
            window.camera.lookAt(0, 0, 0);
            
            window.clock = new THREE.Clock();
            
            animate();
            debugLog('Animation d√©marr√©e');
        }
        
        function setupAdvancedLighting() {
            debugLog('Configuration √©clairage...');
            
            const ambientLight = new THREE.AmbientLight(0x404080, 0.6);
            window.scene.add(ambientLight);
            
            const keyLight = new THREE.DirectionalLight(0xffffff, 1.2);
            keyLight.position.set(3, 8, 5);
            keyLight.castShadow = true;
            keyLight.shadow.mapSize.width = 2048;
            keyLight.shadow.mapSize.height = 2048;
            window.scene.add(keyLight);
            
            const fillLight = new THREE.DirectionalLight(0x88aaff, 0.6);
            fillLight.position.set(-3, 5, -2);
            window.scene.add(fillLight);
            
            const rimLight = new THREE.DirectionalLight(0xff8844, 0.4);
            rimLight.position.set(0, 2, -8);
            window.scene.add(rimLight);
            
            debugLog(`√âclairage configur√© - ${window.scene.children.length} lumi√®res ajout√©es`);
        }
        
        let _lastFrameTime = performance.now();
        function animate() {
            requestAnimationFrame(animate);
            const nowT = performance.now();
            const dt = (nowT - _lastFrameTime) / 1000; // seconds
            _lastFrameTime = nowT;
            
            // Animation de rotation douce pour les objets 3D
            if (scene && scene.children.length > 3) {
                scene.children.forEach(child => {
                    if (child.isMesh && child.name.includes('hand')) {
                        child.rotation.y += 0.005;
                    }
                });
            }
            
            // Hand IK blending update
            if(window.handIK && window.handIK.update){
                try { window.handIK.update(dt); } catch(e){ /* silent */ }
            }
            if (window.renderer && window.scene && window.camera) {
                window.renderer.render(window.scene, window.camera);
            }
        }
        
            // Chargement des mains de recherche (mod√®les GLTF)
        async function loadResearchHand(){
            try {
                clearCurrentHands();
                updateStatus('Chargement main avanc√©e...');
                const loader = new THREE.GLTFLoader();
                const gltf = await new Promise((res,rej)=>loader.load(RESEARCH_HAND_MODEL,res,undefined,rej));
                const hand = gltf.scene;
                hand.name = 'research_hand_right';
                hand.position.set(0.0, 0.9, 0);
                hand.scale.setScalar(1.05);
                scene.add(hand);
                currentHands.right = hand;
                try {
                    const handIKMod = await import('./modules/handIK.js');
                    window.handIK = handIKMod.initHandIK(hand);
                    if(window.handIK) debugLog('HandIK initialis√© (main droite unique)');
                } catch(e){ console.warn('Init HandIK √©chou√©', e); }
                updateStatus('‚úÖ Main avanc√©e charg√©e');
                addMinimalBody();
            } catch(e){
                console.error('Erreur chargement main avanc√©e', e);
                updateStatus('‚ùå √âchec chargement main avanc√©e');
            }
        }

            function addMinimalBody(){
                const body = new THREE.Group();
                body.name='minimal_body';
                const mat = new THREE.MeshLambertMaterial({ color:0x333344 });
                const torso = new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.35,1.0,10), mat);
                torso.position.y=0.3;
                body.add(torso);
                const armGeo = new THREE.CylinderGeometry(0.06,0.06,0.8,8);
                const leftArm = new THREE.Mesh(armGeo, mat); leftArm.position.set(-0.5,0.5,0); leftArm.rotation.z=0.3; body.add(leftArm);
                const rightArm = new THREE.Mesh(armGeo, mat); rightArm.position.set(0.5,0.5,0); rightArm.rotation.z=-0.3; body.add(rightArm);
                scene.add(body);
            }

            // Ancienne fonction loadHandModel supprim√©e (mod√®les GLTF retir√©s)
        
        function loadProceduralModel(type) {
            debugLog(`Chargement mod√®le proc√©dural: ${type}`);
            updateStatus(`Chargement mod√®le 3D: ${type}`);
            
            // Nettoyer les mod√®les existants
            clearCurrentHands();
            
            try {
                if (type === 'both') {
                    loadSingleHand('left', -1);
                    loadSingleHand('right', 1);
                } else if (type === 'right') {
                    loadSingleHand('right', 0);
                }
                debugLog(`Mod√®le ${type} charg√© avec succ√®s`);
            } catch (error) {
                console.error(`‚ùå Erreur chargement mod√®le ${type}:`, error);
            }
        }
        
        function loadSingleHand(side, positionX) {
            debugLog(`Cr√©ation main ${side} √† position ${positionX}`);
            
            // Cr√©ation d'une main proc√©durale avanc√©e
            const handGroup = new THREE.Group();
            handGroup.name = `hand_${side}`;
            
            // G√©om√©tries pour les doigts avec plus de d√©tails
            const fingerGeometry = new THREE.CylinderGeometry(0.02, 0.03, 0.15, 8);
            const thumbGeometry = new THREE.CylinderGeometry(0.025, 0.035, 0.12, 8);
            const palmGeometry = new THREE.BoxGeometry(0.15, 0.05, 0.2);
            
            // Mat√©riaux r√©alistes avec couleur visible
            const skinMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xffcba4,
                shininess: 30,
                transparent: false
            });
            
            // Construction de la paume - VISIBLE
            const palm = new THREE.Mesh(palmGeometry, skinMaterial);
            palm.name = 'palm';
            palm.castShadow = true;
            palm.receiveShadow = true;
            handGroup.add(palm);
            debugLog('Paume ajout√©e');
            
            // Construction des doigts avec os - VISIBLES
            const fingers = ['thumb', 'index', 'middle', 'ring', 'pinky'];
            fingers.forEach((fingerName, i) => {
                const finger = new THREE.Mesh(
                    fingerName === 'thumb' ? thumbGeometry : fingerGeometry, 
                    skinMaterial
                );
                finger.name = fingerName;
                finger.position.set((i - 2) * 0.04, 0.05, fingerName === 'thumb' ? -0.05 : 0.1);
                finger.castShadow = true;
                finger.receiveShadow = true;
                
                // Ajouter des articulations visibles
                // (bloc proc√©dural obsol√®te retir√©)
        
        function loadFullBody() {
            // Corps basique pour contexte
            const bodyGroup = new THREE.Group();
            
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x8888aa });
            
            // Torse
            const torso = new THREE.Mesh(
                new THREE.CylinderGeometry(0.3, 0.4, 1.2, 8),
                bodyMaterial
            );
            torso.position.y = 0;
            bodyGroup.add(torso);
            
            // Bras
            const armGeometry = new THREE.CylinderGeometry(0.08, 0.1, 0.8, 6);
            const leftArm = new THREE.Mesh(armGeometry, bodyMaterial);
            leftArm.position.set(-0.5, 0.2, 0);
            leftArm.rotation.z = 0.3;
            
            const rightArm = new THREE.Mesh(armGeometry, bodyMaterial);
            rightArm.position.set(0.5, 0.2, 0);
            rightArm.rotation.z = -0.3;
            
            bodyGroup.add(leftArm, rightArm);
            
            // Ajouter les mains au bout des bras
            loadSingleHand('left', -0.8);
            loadSingleHand('right', 0.8);
            
            window.scene.add(bodyGroup);
            updateStatus('‚úÖ Corps complet charg√©');
        }
        
        function clearCurrentHands() {
            Object.values(currentHands).forEach(hand => {
                if (hand) scene.remove(hand);
            });
            currentHands = { left: null, right: null };
        }
        
        // Contr√¥leur de main avanc√©
    // HandController supprim√©
        
    function performPhrase(phraseKey) {
            const phrases = {
                'hello': {
                    gesture: { thumb: {x: 0, y: 0, z: 0.8}, index: {x: 0, y: 0, z: 0}, middle: {x: 0, y: 0, z: 0}, ring: {x: 0, y: 0, z: 0}, pinky: {x: 0, y: 0, z: 0} },
                    dhatu: 'COMM',
                    description: 'Salutation universelle - Communication sociale'
                },
                'thank_you': {
                    gesture: { thumb: {x: 0.5, y: 0, z: 0.3}, index: {x: 0, y: 0, z: 0}, middle: {x: 0, y: 0, z: 0}, ring: {x: 0, y: 0, z: 0}, pinky: {x: 0, y: 0, z: 0} },
                    dhatu: 'EVAL',
                    description: 'Gratitude - √âvaluation positive'
                },
                'how_are_you': {
                    gesture: { thumb: {x: 0, y: 0, z: 0.8}, index: {x: 0, y: 0.3, z: 0}, middle: {x: 1.4, y: 0, z: 0}, ring: {x: 1.4, y: 0, z: 0}, pinky: {x: 1.4, y: 0, z: 0} },
                    dhatu: 'COMM',
                    description: 'Question sur l\'√©tat - Communication interrogative'
                },
                'i_love_you': {
                    gesture: { thumb: {x: 0, y: 0, z: 0.8}, index: {x: 0, y: 0, z: 0}, middle: {x: 1.4, y: 0, z: 0}, ring: {x: 1.4, y: 0, z: 0}, pinky: {x: 0, y: 0, z: 0} },
                    dhatu: 'FEEL',
                    description: 'Expression d\'amour - √âmotion affective'
                },
                'goodbye': {
                    gesture: { thumb: {x: 0, y: 0, z: 0}, index: {x: 0, y: 0, z: 0}, middle: {x: 0, y: 0, z: 0}, ring: {x: 0, y: 0, z: 0}, pinky: {x: 0, y: 0, z: 0} },
                    dhatu: 'COMM',
                    description: 'Au revoir - Communication de d√©part'
                },
                'please': {
                    gesture: { thumb: {x: 0.3, y: 0, z: 0.2}, index: {x: 1.2, y: 0, z: 0}, middle: {x: 0, y: 0, z: 0}, ring: {x: 0, y: 0, z: 0}, pinky: {x: 0, y: 0, z: 0} },
                    dhatu: 'MODAL',
                    description: 'Demande polie - Modalit√© de politesse'
                }
            };
            
            const phrase = phrases[phraseKey];
            if (phrase && window.handIK) {
                try { window.handIK.transitionToHandshape('A'); } catch(e) {}
                selectDhatu(phrase.dhatu);
                updateStatus(`${phrase.description} ‚Ä¢ DhƒÅtu: ${phrase.dhatu} ‚Ä¢ Langue: ${currentLanguage}`);
            }
        }
        
    /* Duplicate animate() supprim√© ‚Äì boucle principale d√©j√† d√©finie plus haut avec dt + HandIK */
        
        function selectDhatu(dhatuName) {
            // Mise √† jour visuelle des boutons (anciens items statiques si pr√©sents)
            document.querySelectorAll('.dhatu-item').forEach(item => item.classList.remove('active'));
            const staticBtn = document.querySelector(`[data-dhatu="${dhatuName}"]`);
            if(staticBtn) staticBtn.classList.add('active');
            currentDhatu = dhatuName;
            updateStatus();
            // Ouvrir section collapsible correspondante
            const match = Array.from(document.querySelectorAll('#dhatu-sections .dhatu-collapsible'))
                .find(div => div.firstChild && div.firstChild.textContent.includes(dhatuName));
            if(match){
                const body = match.children[1];
                if(body && body.style.display==='none') body.style.display='block';
            }
        }
        
    // updateDhatuDisplay supprim√© (contenu dans sections collapsibles)
        
        function selectLanguage(language) {
            // Mise √† jour visuelle des boutons
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            currentLanguage = language;
            updateStatus();
            
            // Mise √† jour de l'alphabet selon la langue
            updateAlphabetTitle(language);
        }
        
        function updateAlphabetTitle(language) {
            const title = document.querySelector('.language-group:last-child .language-title');
            title.textContent = `Alphabet (current: ${language})`;
        }
        
        function performLetter(letter) {
            console.log(`Ex√©cution de la lettre ${letter} en ${currentLanguage} avec dhƒÅtu ${currentDhatu}`);
            
            // Configurations alphabet selon langue
            const alphabetConfigs = {
                'LSQ': {
                    'A': { thumb: {x: 0, y: 0, z: 0.9}, index: {x: 1.4, y: 0, z: 0}, middle: {x: 1.4, y: 0, z: 0}, ring: {x: 1.4, y: 0, z: 0}, pinky: {x: 1.4, y: 0, z: 0} },
                    'B': { thumb: {x: 0.8, y: 0, z: 0.2}, index: {x: 0, y: 0, z: 0}, middle: {x: 0, y: 0, z: 0}, ring: {x: 0, y: 0, z: 0}, pinky: {x: 0, y: 0, z: 0} }
                },
                'ASL': {
                    'A': { thumb: {x: 0.2, y: 0, z: 0.7}, index: {x: 1.2, y: 0, z: 0}, middle: {x: 1.2, y: 0, z: 0}, ring: {x: 1.2, y: 0, z: 0}, pinky: {x: 1.2, y: 0, z: 0} },
                    'B': { thumb: {x: 0.9, y: 0, z: 0.1}, index: {x: 0, y: 0, z: 0}, middle: {x: 0, y: 0, z: 0}, ring: {x: 0, y: 0, z: 0}, pinky: {x: 0, y: 0, z: 0} }
                },
                'LSF': {
                    'A': { thumb: {x: 0.1, y: 0, z: 0.8}, index: {x: 1.3, y: 0, z: 0}, middle: {x: 1.3, y: 0, z: 0}, ring: {x: 1.3, y: 0, z: 0}, pinky: {x: 1.3, y: 0, z: 0} },
                    'B': { thumb: {x: 0.7, y: 0, z: 0.3}, index: {x: 0, y: 0, z: 0}, middle: {x: 0, y: 0, z: 0}, ring: {x: 0, y: 0, z: 0}, pinky: {x: 0, y: 0, z: 0} }
                }
            };
            
            const config = alphabetConfigs[currentLanguage]?.[letter] || alphabetConfigs['LSQ'][letter];
            
            if(window.handIK){
                try { window.handIK.transitionToHandshape(letter); } catch(e){ console.warn('HandIK transition error', e); }
                const analysis = analyzeLetterWithDhatu(letter, currentDhatu);
                updateStatus(`Lettre ${letter} (${currentLanguage}) ‚Ä¢ ${analysis} ‚Ä¢ DhƒÅtu: ${currentDhatu}`);
            } else {
                updateStatus(`Lettre ${letter} ‚Ä¢ HandIK non initialis√©`);
            }
            
            // Animation de feedback
            event.target.style.transform = 'scale(1.3)';
            event.target.style.background = 'rgba(255, 102, 0, 0.7)';
            
            setTimeout(() => {
                event.target.style.transform = 'scale(1)';
                event.target.style.background = 'rgba(0, 255, 136, 0.3)';
            }, 300);
        }

        function performDigit(digit){
            if(window.handIK){
                try { window.handIK.transitionToHandshape(digit); } catch(e){}
                updateStatus(`Chiffre ${digit} ‚Ä¢ DhƒÅtu: ${currentDhatu}`);
            }
        }
        
        function analyzeLetterWithDhatu(letter, dhatu) {
            const analyses = {
                'RELATE': `Position spatiale de ${letter}`,
                'MODAL': `Modalit√© gestuelle ${letter}`,
                'EXIST': `Existence temporelle ${letter}`,
                'EVAL': `√âvaluation forme ${letter}`,
                'COMM': `Communication ${letter}`,
                'CAUSE': `Action causale ${letter}`,
                'ITER': `R√©p√©tition ${letter}`,
                'DECIDE': `Choix structural ${letter}`,
                'FEEL': `Expression √©motive ${letter}`
            };
            return analyses[dhatu] || `Analyse ${letter}`;
        }
        
        function updateStatus(message = null) {
            const defaultMessage = `DhƒÅtu: ${currentDhatu} ‚Ä¢ Langue: ${currentLanguage} ‚Ä¢ Couverture: 92% universelle`;
            document.getElementById('status-bar').textContent = message || defaultMessage;
        }

        function setupDiagnosticsOverlay(signVersions, facialVersion){
            if(document.getElementById('diag-overlay')) return;
            const div = document.createElement('div');
            div.id = 'diag-overlay';
            div.style.position='fixed';
            div.style.bottom='10px';
            div.style.right='10px';
            div.style.background='rgba(0,0,0,0.75)';
            div.style.padding='8px 12px';
            div.style.fontSize='11px';
            div.style.fontFamily='monospace';
            div.style.border='1px solid #444';
            div.style.borderRadius='6px';
            div.style.zIndex='1500';
            div.innerHTML = `Sign Runtime<br>Handshapes v${signVersions?.handshapes||'?'} | NMF v${signVersions?.nmfRules||'?'} | Facial v${facialVersion||'?'}<br><span id="diag-last-compose">compose: -- ms</span> | <span id="diag-last-validate">validate: --/--</span>`;
            document.body.appendChild(div);
            // Monkey patch compose & validate to update overlay
            if(window.signRuntime){
                const origCompose = window.signRuntime.compose;
                window.signRuntime.compose = function(opts){
                    const spec = origCompose(opts);
                    const el = document.getElementById('diag-last-compose');
                    if(el) el.textContent = `compose: ${spec.meta.composeMs} ms`;
                    return spec;
                };
                const origValidate = window.signRuntime.validate;
                window.signRuntime.validate = function(spec){
                    const res = origValidate(spec);
                    const el = document.getElementById('diag-last-validate');
                    if(el) el.textContent = `validate: ${res.errors.length}/${res.warnings.length}`;
                    return res;
                };
            }
        }
        
        // Gestion du redimensionnement
        window.addEventListener('resize', () => {
            const canvasArea = document.getElementById('canvas-area');
            camera.aspect = canvasArea.clientWidth / canvasArea.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvasArea.clientWidth, canvasArea.clientHeight);
        });
        
        // Initialisation au chargement
        window.addEventListener('load', init);
    </script>
</body>
</html>
